---
title: 计网学习笔记-7
date: 2025-11-29 17:31:07
categories: 计网
description: 《计算机网络——自顶向下方法》第七章学习笔记。
tags: [计算机网络, 无线网络, 移动网络]
---
# 无线网络和移动网络
从网络视角来看，无线通信与移动性毫无疑问地共同引入了有别于传统有线网络的一系列新挑战，尤其体现在链路层和网络层。因此，这部分内容有必要单独讨论。（其实是我确实很好奇啊 awa）

需要首先区分两个概念：**无线性**指通信链路通过无线电波建立，而非依赖物理线缆；**移动性**则指终端在网络中动态变更接入位置。两者并非必然同时出现，例如家用 Wi-Fi 下的台式机具备无线性却缺乏移动性，而用户携带笔记本从家到公司并改用有线网络时则具备移动性但不具备无线性。最复杂的情形无疑是二者的叠加情况，比如用户在高速移动的车辆中持续进行语音或数据通信。

本章将以这一交集为主线展开：首先介绍无线用户如何经由网络边缘的无线链路接入更大的（通常是有线的）网络基础设施；随后分析无线链路的特性，并简述蜂窝系统中广泛采用的码分多址（CDMA）。接着深入阐述 IEEE 802.11（Wi-Fi）的链路层机制，并概览蓝牙等个人域网技术；之后介绍 3G 与 4G/LTE 等蜂窝接入技术，它们统一支持语音与高速数据业务；再进一步讨论移动性管理，包括位置更新、路由维护与切换等核心问题；并说明企业 Wi-Fi 与 LTE 网络中如何利用移动 IP 来实现无缝移动服务。最后，本章将探讨无线性和移动性对传输层协议（如 TCP）以及实时视频等网络应用的影响。

通过以上内容，我们将整体理解无线与移动网络的核心运行原理，以及它们在设计上面临的主要挑战。

## 概述
本章讨论的无线与移动网络场景涵盖了从 Wi-Fi 到 4G 在内的多种技术。为了建立一致的理解，我们首先引入几个关键概念：

- **无线主机**：运行应用的端系统设备，如手机、笔记本、平板或嵌入式设备。它可以是静止的，也可以移动。  
- **无线链路**：主机通过**无线通信链路**与基站或其他设备通信的通道。不同技术（如 Wi-Fi、蜂窝）在速率和覆盖范围上差异很大，且性能受距离、干扰和用户数量影响。  
- **基站**：无线网络中的核心基础设施，在有线网络中没有直接对应设备。它负责与主机进行无线通信，接收数据并将其接入更大的网络（如互联网），同时负责协调其覆盖区域内主机的传输。典型例子包括蜂窝网络的**蜂窝塔**以及无线局域网中的**接入点**（Access Point, AP）。
- **网络基础设施**：指无线主机最终要访问的更大网络，如因特网或企业内网。

当主机位于基站覆盖范围内，并通过基站接入网络时，被称作以**基础设施模式**运行。在这种模式下，所有地址分配、路由等传统的网络服务都由网络基础设施统一提供。另一种通信方式是**自组织网络**（ad hoc），在这种网络中，没有基站存在，主机之间直接通信，必须自行完成路由、地址配置、类似 DNS 的域名转换等功能。

当移动主机从一个基站覆盖区进入另一个时，需要**切换**到新的基站。由此产生了一系列挑战，包括如何定位移动设备、如何为其分配地址，以及如何在移动过程中保持 TCP 连接或语音通话的连续性。

根据无线通信是单跳还是多跳，以及网络中是否存在基站等基础设施，可将无线网络划分为四类：

1. **单跳，基于基础设施**：  
   主机通过一个无线跳与基站通信，基站再连入有线网络。  
   **典型代表**：家庭/办公室 Wi-Fi、4G/5G 蜂窝网络。这是最常见、最主流的类型。

2. **单跳，无基础设施**：  
   无基站，主机直接通信，但通常由其中一个设备协调（如蓝牙主从模式）。  
   **典型代表**：蓝牙耳机、键盘，或 Wi-Fi 直连（自组织模式）。

3. **多跳，基于基础设施**：  
   主机通过多个无线节点中继，最终到达有线连接的基站。  
   **典型代表**：无线网状网络、某些传感网络。

4. **多跳，无基础设施**：  
   无基站，通信需经多个移动节点中继。  
   **典型代表**：移动自组织网络（MANET）、车联网（VANET）。这类网络协议设计复杂，仍在研究中。

## 无线链路和网络特征
如果用无线 802.11 网络替换有线以太网，也就是让无线网络接口取代有线以太网接口、让 AP 取代交换机，那么在网络层及以上几乎不需要做任何调整。这说明，有线与无线网络之间最核心的差异主要体现在链路层。

无线链路与有线链路相比，面临几个特有的挑战：

- **信号衰减**：电磁波在传播过程中会因距离增加而减弱（称为路径损耗），穿墙或障碍物时还会进一步衰减。  
- **干扰**：多个设备若使用相同频段（如 2.4 GHz 的 Wi-Fi 与无线电话），会相互干扰；此外，微波炉、电机等电器也会产生电磁噪声。  
- **多径传播**：信号经不同路径（如反射、绕射）到达接收端，导致波形叠加失真，且随环境变化而动态改变。

这些因素使得**无线链路的比特错误率显著高于有线链路**。因此，无线协议（如 802.11）不仅使用强效的 CRC 进行差错检测，还引入**链路层 ARQ 机制**，对出错的帧进行自动重传。

考虑了噪声后，可以知道接收端收到的信号是原始信号的退化版本与环境噪声的混合。衡量信号质量的关键指标是**信噪比**（Signal-to-Noise Ratio, SNR），也即所收到的信号和噪声强度的相对测量。SNR 越高，接收方越容易从噪声中正确恢复数据。

虽然不同的调制方式（如 BPSK、QAM）和编码策略会影响传输效果，但在相同调制条件下，SNR 越高，**比特差错率**（BER）就越低这一规律始终成立。发送方可以通过提高发射功率来提升 SNR，从而降低误码率并增强可靠性，但功率带来的收益并非无限增长。当 BER 已经非常低（例如从 $10^{-12}$ 再降到 $10^{-13}$）时，继续增大发射功率带来的改善几乎可以忽略不计，反而会引发额外问题，例如移动设备能耗升高，以及更强信号导致的无线干扰加剧。

此外，调制方式的选择也需要在速率与可靠性之间进行权衡。在相同的 SNR 下，高速调制方式（如 QAM16）通常会比低速调制方式更容易出错。例如，在 SNR 为 10 dB 时，低速的 BPSK 可以保持极低的误码率，而高速的 QAM16 误码率可能高到无法应用；但当 SNR 提升到 20 dB 时，QAM16 就能够在可接受的误码率下工作，从而提供更高的吞吐量。

因此，现代无线系统（如 Wi-Fi 和 4G/5G）普遍采用**自适应调制与编码**（AMC），根据实时信道状况（如 SNR）动态选择合适的调制方式和编码率，在保证误码率满足要求的同时尽可能提高传输速率。

除了更高且随时间变化的误码率外，无线链路还面临有线网络所没有的另一类挑战，就是多路访问更加复杂。在有线广播网络中，所有节点都能清晰地“听到”彼此的传输，因而容易进行协调；而在无线环境中，由于**隐藏终端问题**和**信号衰减**的存在，节点往往无法准确判断其他节点的发送情况，使得多路访问控制变得更加困难。

- **隐藏终端问题**：两个发送方（A 和 C）彼此无法侦听到对方，却同时向同一个接收方（B）发送，导致在 B 处发生碰撞，而 A 和 C 并不知道冲突发生；  
- **信号衰减**：即使 A 和 C 距离不远，其信号在传播中可能已衰减到无法被对方检测，但仍足以在接收端相互干扰。

这些现象使得无线网络中的碰撞更难避免和检测，因此其多路访问机制（如 802.11 的 RTS/CTS）比有线网络复杂得多。

### CDMA
在上一章中我们提到，当多个设备共享同一通信媒介时，需要多路访问协议来避免彼此干扰。CDMA 的做法是为每个发送方分配一个独特的编码序列。所有用户可以同时占用整个频带，但各自通过不同的码对数据进行标记，从而在接收端得以区分。

在 CDMA 中，每个待发送的数据比特都会被扩展成一串速率更高的“码片”，这一过程称为**扩频**。其基本做法是使用预先分配的、独特的编码序列去调制原始数据比特，使不同用户的比特在同一频带中以各自的码片序列区分开来。用于调制的编码序列变化得非常快，其变化速率（即**码片速率**）远高于原始比特序列的变化速率。

假设一个数据比特持续一个比特时隙，并被划分为 $M$ 个码片时隙（如 $M=8$，实际系统中常更大）。发送方为每个比特分配一个由 $+1$ 和 $-1$ 组成的长度 $M$ 的编码向量。为便于数学处理，原始比特 0 映射为 $-1$，1 映射为 $+1$。发送时，将比特值与该编码向量逐分量相乘，即可得到包含 $M$ 个码片的发送向量，从而将低速比特流扩展为高速的码片序列。

在接收端，将收到的码片序列视为一个向量。接收方用和发送方相同的编码序列向量与该接收向量做内积并归一化，就能恢复出自身的原始比特。原因在于若不同用户的编码序列近似正交，则它们的向量内积接近于零。于是，在接收到的混合信号中，各用户信号相加可写为多个“编码向量的线性组合”。当接收方与自己的编码向量做内积时，只有对应项会产生非零的放大效果，其余用户的编码因正交而被抵消，从而实现同时发送、互不干扰的多址接入。

一个简单的 CDMA 例子如下图：
<figure style="text-align: center;">
<img src="/illustrations/计网笔记7/1.png" alt="简单的 CDMA 例子" width="70%">
<figcaption>简单的 CDMA 例子</figcaption>
</figure>

因此，CDMA 通过“编码划分”实现了多用户共享同一频段，其有效性依赖精心设计的正交编码和合理的功率控制。具体来说，首先编码设计要足够优良，使不同用户的信号在数学上可分离，其次要保证各信号到达接收端的强度相近，否则强信号可能淹没弱信号。而尽管实际部署中存在同步和功率控制等挑战，CDMA 的优势在于**频谱利用率高、抗干扰能力强**，特别适合无线环境，因此成为早期 3G 蜂窝系统的核心技术之一。

## WiFi：802.11 无线 LAN
如今，无线局域网（WLAN）已无处不在，无论是办公室、家庭、校园、机场，还是街头，都能看到它的身影，成为互联网接入的重要方式。在众多早期标准中，**IEEE 802.11**（即 Wi-Fi）最终脱颖而出，成为主流。

尽管 802.11 协议族包含多个版本，但它们共享几个关键特性：  
- 使用相同的**链路层帧结构**；  
- 采用统一的**媒体访问控制协议**（CSMA/CA，稍后详述）；  
- 支持**速率自适应**：信号弱时自动降低速率以延长传输距离；  
- **向后兼容**：老设备（如仅支持 802.11g 的手机）仍能与新基站（如 802.11ac）通信。

它们的主要差异体现在**物理层**，尤其是工作频段和速率。2.4 GHz 频段（2.4–2.485 GHz）无需授权，覆盖范围较广，但易受微波炉、蓝牙等设备干扰；5 GHz 频段（5.1–5.8 GHz）干扰少、速率高，但穿墙能力弱，传输距离较短。较新的标准如 **802.11n** 和 **802.11ac** 引入了**多输入多输出**（MIMO）技术，通过多个天线同时收发不同数据流显著提升吞吐量和可靠性。802.11ac 还支持**多用户 MIMO**和**波束成形**，能够将信号能量集中指向目标设备，减少干扰并增强覆盖。

需要注意的是，标称速率（如 1300 Mbps）是在理想环境下测得的，例如在近距离且无干扰的条件下。实际使用中，速率通常远低于标称值。

总体而言，802.11 通过统一架构、平滑演进和强大兼容性，奠定了其在无线接入领域的主导地位。

### 802.11 体系结构
802.11 无线局域网的基本组成单元是**基本服务集**（Basic Service Set, BSS），一个 BSS 包含一个或多个无线设备（如手机、笔记本）和一个**接入点**（Access Point, AP）。在 802.11 网络中，AP 相当于无线网络的**基站**，负责协调各设备的通信并接入更大的网络。AP 通常通过有线网络（如以太网交换机或路由器）连接到互联网，在家庭环境中，AP 与路由器常被集成在同一设备中。

和以太网一样，每个 802.11 无线站点和 AP 的无线接口都拥有一个 6 字节的 MAC 地址，同样由 IEEE 统一分配，理论上全球唯一。

这种由 AP 和有线基础设施支撑的网络称为**基础设施模式无线 LAN**，是最常见的 Wi-Fi 部署方式。802.11 也支持**自组织网络**（ad hoc mode），在这种模式下，无线设备之间可以直接通信，无需 AP 或外部网络，例如会议室中几台笔记本临时组网共享文件。尽管自组织网络在特定场景下有其用途，本节将重点讨论**基础设施模式**的无线 LAN。

在基础设施模式下运行的 802.11 网络中，无线设备（如手机或笔记本）必须先与 AP 建立连接才能收发网络数据。网络管理员在部署 AP 时，会为其配置两个关键参数，确保网络正常运行和高效管理：

- **服务集标识符**（SSID）：网络名称，例如 “HomeWiFi” 或 “Cafe_Guest”；  
- **信道号**：在 2.4 GHz 频段（2.4–2.4835 GHz）中，共有 11 个信道，但只有 **信道 1、6、11** 互不重叠，因此在部署多个 AP 时通常选用这三个信道，以减少相互干扰。

当用户进入一个“**Wi-Fi 丛林**”（即多个 AP 信号重叠的区域，如城市咖啡馆），设备需要从中选择一个 AP 进行关联。关联后，设备的所有通信都通过该 AP 转发，其他 AP 不会为其提供服务。

在 802.11 网络中，无线设备通过扫描可用信号来发现附近的 AP。每个 AP 定期广播**信标帧**，每个信标帧包含其 SSID 和 MAC 地址。设备可通过两种方式进行扫描以获取这些信息：

- **被动扫描**：依次监听所有 11 个信道，收集收到的信标帧；  
- **主动扫描**：向所有信道广播**探测请求帧**，附近的 AP 会立即回复**探测响应帧**。

发现可用 AP 后，设备需要决定关联哪一个。802.11 标准并未规定具体选择算法，这通常由设备固件实现。最常见的策略是选择**信号最强的 AP**，但这并非总是最优选择，因为信号强的 AP 可能已连接大量用户而导致带宽拥挤，而稍弱但空闲的 AP 反而可能提供更好的使用体验。

选定 AP 后，设备发送**关联请求帧**，AP 回复**关联响应帧**，完成关联。这一步类似于 DHCP 客户端从多个服务器中选择一个，需明确确认最终选择。

关联成功后，设备通常会通过该 AP 发起 **DHCP 请求**，获取该子网的 IP 地址，从而正式成为该网络的一员。

最后，许多网络还要求**身份认证**，常见方式包括基于 MAC 地址的白名单或用户名/密码登录（如咖啡馆的网页认证）。在实际部署中，AP 通常将认证请求转发给后台的**认证服务器**（如 RADIUS 服务器），实现集中管理，使得一个鉴别服务器能够服务于多个 AP，同时降低 AP 本身的复杂度。这一架构也被现代安全标准（如 802.11i）所采用。

### 802.11 MAC 协议
一旦无线设备与 AP 成功关联，就可以通过该 AP 发送和接收数据帧。然而，由于多个站点共享同一无线信道，必须使用**多路访问协议**来协调传输。受以太网经验启发，802.11 采用了一种**随机接入协议**，称为**载波侦听多路访问/碰撞避免**（CSMA/CA）。与以太网的 CSMA/CD 类似，CSMA/CA 也要求站点在发送前先侦听信道，如果信道忙则推迟发送，但两者存在两个关键区别：

- 802.11 使用“碰撞避免”，而非“碰撞检测”；  
- 802.11 引入了链路层确认与重传机制（ARQ），而传统以太网没有。

802.11 不采用碰撞检测主要有两点原因：无线网卡无法在发送的同时可靠接收信号，因发射功率远大于接收信号，实现碰撞检测的硬件既复杂又昂贵；同时，即便能监听，隐藏终端和信号衰减也会使碰撞难以被准确识别。因此，802.11 一旦开始发送就会将帧完整发送到底，不像以太网那样在检测到碰撞后中止。为降低碰撞带来的开销，802.11 标准依赖随机回退、RTS/CTS 等碰撞避免机制，使冲突尽量不发生。

具体来说，CSMA/CA 引入了**随机回退**机制，在信道由忙转空时让各站点独立倒计时，只要回退值不同，就能错开发送时机；且在倒计时过程中，一旦侦听到其他设备开始传输，站点会立即冻结计数器，待信道再次空闲后再继续，从而进一步减少碰撞的可能性。

当然，即使采用 CSMA/CA 机制，碰撞仍可能发生，例如两个站点是彼此感知不到的“隐藏终端”，或它们的随机回退值过于接近，从而几乎同时开始发送。

此外，为应对无线链路较高的错误率，802.11 采用**链路层确认机制**：  
- 接收方在收到并通过 CRC 校验的帧后，会等待一个很短的固定时间，称为**短帧间间隔**（Short Inter-Frame Spacing, SIFS），然后发送一个**ACK 帧**。
- 发送方若在规定时间内未收到 ACK，就认为传输失败，并使用 CSMA/CA 重传该帧；  
- 若重传多次仍失败，则放弃该帧。

在了解 802.11 采用的随机回退和链路层确认机制之后，我们可以更完整地描述 CSMA/CA 的工作流程。假设某个站点（无线设备或 AP）有帧需要发送，它会按照以下步骤进行操作：

1. **若信道处于空闲状态**，站点不会立刻发送，而是先等待一个固定的短时间，即**分布式帧间间隔**（Distributed Inter-Frame Space, DIFS），随后才开始发送。
2. **如果信道忙**，站点会随机选择一个“回退计数值”，并在信道空闲时逐单位递减；信道一旦变忙，计数暂停。  
3. **当计数值减到 0 时**（此时信道必定空闲），站点发送整个数据帧，并等待接收方的 ACK 确认。  
4. **若收到 ACK**，说明传输成功；若需发送下一帧，则重新进入步骤 2。  
   **若未收到 ACK**，则视为失败，站点回到步骤 2，但**从更大的随机范围内选择新的回退值**（类似二进制指数后退）。

基础的 802.11 协议就是这样，已经能够解决大多数情况，但在此之上还引入了一些有趣的拓展机制，例如利用 RTS/CTS 帮助解决隐藏终端问题、将 802.11 用作点对点链路以拓展部署方式等，使无线网络在更复杂的环境中仍能保持较高的通信效率。

#### 处理隐藏终端：RTS/CTS 机制
802.11 MAC 协议提供了一种可选但有效的**信道预约机制**，用于缓解隐藏终端问题。其要解决的情形是，若 H1 正在向 AP 发送数据，而 H2 又听不到 H1 的传输，那么 H2 可能在中途开始发送，从而在 AP 处形成碰撞，使双方的帧都无法成功接收并导致信道资源被浪费。

为避免这种情况，802.11 允许发送方在传输数据前先进行预约：

1. 发送方（如 H1）向 AP 发送一个短**请求发送**（Request to Send, RTS）控制帧，其中包含后续数据帧和确认帧所需的总时间；  
2. AP 收到 RTS 后，广播一个短**允许发送**（Clear to Send, CTS）控制帧作为响应；  
3. 所有收到 CTS 的站点（包括隐藏的 H2）都会在指定时间内**暂停发送**，为即将进行的数据传输让出信道。

由于 RTS 和 CTS 帧都很短，即使发生碰撞，代价也远低于长数据帧的碰撞。一旦 RTS/CTS 成功交换，后续的数据帧和确认帧便能在受保护的时间窗口内无冲突地完成传输。通过这种以短控制帧方式提前预约信道的做法，RTS/CTS 能够有效缓解隐藏终端导致的碰撞，提升无线网络的可靠性与整体效率。

虽然 RTS/CTS 交换能够降低碰撞发生的概率，但同时也会带来额外时延并占用信道资源，因此该机制通常仅用于为较长的数据帧预约信道。实际中，每个无线站点都会配置一个 RTS 门限值，只有当即将发送的数据帧长度超过这一门限时才会启用 RTS/CTS。对于许多设备而言，默认的 RTS 门限值高于最大帧长，因此所有数据帧都会直接发送，RTS/CTS 序列在绝大多数情况下被跳过。

#### 使用 802.11 作为点对点链路
前面的讨论聚焦于 802.11 在多路访问（共享信道）场景下的工作方式。但实际上，802.11 也可用于**点对点通信**，只要两个节点配备**定向天线**并相互对准，就能在一条专用无线链路上运行 802.11 协议。

由于商用 802.11 硬件成本低廉，通过搭配定向天线和适当提升发射功率，802.11 可以成为一种经济高效的方案，用于建立数十公里距离的无线点对点连接。这种模式已被用于构建远距离多跳无线网络，例如在偏远地区提供互联网接入。

### IEEE 802.11 帧
尽管 802.11 帧与以太网帧在功能上相似，但为适应无线环境，其结构包含一些特有的字段，如下图所示：
<figure style="text-align: center;">
<img src="/illustrations/计网笔记7/2.png" alt="802.11 帧" width="80%">
<figcaption>802.11 帧</figcaption>
</figure>

1. 有效载荷与 CRC  
   - **有效载荷**：通常是一个 IP 数据报或 ARP 分组，最大可达 2312 字节，但一般不超过 1500 字节（以太网 MTU）；
   - **CRC 字段**（4 字节）：用于检测传输中的比特错误。由于无线链路误码率较高，CRC 在此尤为重要。

2. 四个地址字段  
   802.11 帧包含**最多四个 MAC 地址字段**（各 6 字节），这在以太网中是没有的。在**基础设施模式**下，主要使用前三个：

   - **地址 1**：帧的**接收方**（如 AP 或无线站点）的 MAC 地址；  
   - **地址 2**：帧的**发送方**（如无线站点或 AP）的 MAC 地址；  
   - **地址 3**：无线链路外**真正的通信对端**（一般是路由器）的 MAC 地址，用于桥接无线与有线网络。

   之所以需要地址 3，是因为 AP 在无线与有线网络之间承担着桥接角色。当有线侧的路由器将数据发往无线站点时，它会根据目标 IP 通过 ARP 获得无线站点的 MAC 地址，并封装成 802.3 以太网帧；AP 接收到该帧后会将其转换为 802.11 格式，其中地址 1 是无线站点的 MAC（实际接收者），地址 2 是 AP 的 MAC（无线侧发送者），地址 3 则保留原始以太网帧中的路由器 MAC（最初的发送者）。反向通信时，无线站点会把地址 3 设置为路由器的 MAC，使 AP 能知道如何将帧从无线侧转发回有线侧。因此，地址 3 对 AP 的桥接功能至关重要，它让 AP 能在不同链路层格式之间保持正确的转发，而无需解析更高层的 IP 信息。

   > 第四个地址用于自组织网络中的多跳转发，基础设施模式中通常不使用。

3. 控制字段  
   - **序号字段**：用于识别重传帧，避免重复处理（类似 TCP 序号）；  
   - **持续期字段**：在 RTS/CTS 或数据帧中指明信道将被占用的时长，供其他站点协调退避；  
   - **帧控制字段**：包含多个标志位，其中关键的有：
      - **类型/子类型**：区分数据帧、ACK、RTS、CTS、管理帧等；
      - **To AP / From AP**：指示帧的流向，帮助解析各地址字段的含义；
      - **WEP 位**：标志是否启用加密。

综上，802.11 帧通过扩展地址和控制字段，有效支持了无线环境下的桥接、可靠传输与多路访问协调，同时保持与有线以太网的兼容性。

### 在相同的 IP 子网中的移动性
为扩大覆盖范围，企业或校园通常会在同一 IP 子网中部署多个 BSS，这就要求无线设备能够在**保持现有 TCP 连接**的前提下，从一个 BSS 平滑切换到另一个，实现无缝移动。

当所有 BSS 属于同一个 IP 子网时，移动性非常简单。此时移动设备（例如主机 H1）在 AP 间漫游时**无需更改 IP 地址**，因此正在进行的 TCP 连接不会中断。具体过程是：当 H1 在远离 AP1 时信号逐渐减弱，它会扫描更强的信号源；当发现 AP2 正在广播相同的 SSID 时，H1 会与 AP1 解除关联，再与 AP2 建立关联，对上层协议而言，这一切都是透明的。

由于交换机通过自学习维护 MAC 地址表，移动前 H1 的 MAC 地址映射到 AP1 的端口，那么移动后，如果转发表尚未更新，发往 H1 的帧仍会被错误地发送至 AP1，从而产生丢包。为避免这种情况，实际部署中，AP2 在完成关联后会主动以 H1 的 MAC 地址发送一个“伪造”以太网帧（通常是广播或单播），促使交换机更新其转发表，把 H1 的位置切换为 AP2 所在的端口，从而尽快恢复正常通信。

虽然 IEEE 曾试图通过 802.11f 规范 AP 之间的协作，但该标准未被广泛采用，厂商普遍使用自己的私有机制实现类似的漫游优化。

如果一个 VLAN 内只包含一个 IP 子网，也能在 VLAN 内实现上述移动性机制。VLAN 本质上提供了一个跨越多个物理位置的**同一链路层广播域**，使这些 BSS 共享同一子网地址。只要设备逻辑上仍处于同一 IP 子网，在 AP 间移动时无需更改 IP，现有会话也不会中断。相反，如果设备移动到另一个 VLAN 或 IP 子网，则 IP 地址必须更新，此时需要更复杂的移动性支持技术（如移动 IP），将在后续章节详细讨论。

### 802.11 中的高级功能
802.11 网络中还提供一些高级功能，这些功能并非标准所强制规定，网络设备可以根据需要自行实现。

1. 速率自适应
   802.11 支持根据无线信道质量**动态调整传输速率**。当用户靠近 AP 时，SNR 高，可使用高阶调制（如 64-QAM）实现高速传输；当用户远离、信号变差时，若维持高速率，BER会急剧上升，导致通信失败。为此，许多 802.11 设备采用**速率自适应机制**：

   - 如果连续发送的帧未收到 ACK（暗示出错），就**降低速率**；
   - 如果连续多个帧成功收到 ACK，或经过一段稳定期，就**尝试提升速率**。

   这种“试探式”策略与 TCP 拥塞控制思想类似：在信道条件好时“试探”更高性能，一旦出错就“回退”。虽然不同厂商实现方式各异，但目标一致，就是在可靠性与吞吐量之间取得最佳平衡。
2. 功率管理
   对电池供电的移动设备，节能至关重要。802.11 提供了内置的**省电机制**：

   - 设备可在**睡眠**和**唤醒**状态间切换。进入睡眠前，向 AP 设置帧中的“功率管理”位为 1，告知自己即将休眠；
   - AP 收到后，会**缓存**发往该设备的帧，不立即发送；
   - 设备设置定时器，在 AP 发送**信标帧**（通常每 100ms 一次）前自动唤醒（仅需约 250 微秒）；  
   - 信标帧中包含一个列表，标明哪些设备有缓存数据。若无数据，设备立即返回睡眠；若有，则发送请求获取缓存帧。

   通过这种方式，设备在大部分时间处于低功耗睡眠状态，仅在极短时间内唤醒检查，整体能耗可降低 90% 以上，显著延长电池寿命。

这两项功能虽非 802.11 强制要求，但已成为现代 Wi-Fi 设备的标配，极大提升了无线网络的实用性与用户体验。

### 个人域网络
除了用于无线局域网的 802.11，IEEE 还制定了适用于短距离、低功耗场景的个人域网标准，主要包括**蓝牙**（802.15.1）和 **ZigBee**（802.15.4）。

**蓝牙**本质上是一种“电缆替代”技术，工作在 2.4 GHz 频段，传输距离通常在 10 米以内，速率最高可达 4 Mbps。它采用**跳频扩频**（FHSS）技术，在 79 个信道间快速切换，以抗干扰。蓝牙网络称为**皮可网**，由一个主设备和最多 7 个从设备组成，所有通信都通过主设备中转。此外，还可有最多 255 个“寄存”设备，需经主设备激活后才能通信。蓝牙是**自组织网络**，无需接入点等基础设施。
<figure style="text-align: center;">
<img src="/illustrations/计网笔记7/3.png" alt="蓝牙皮可网" width="60%">
<figcaption>蓝牙皮可网</figcaption>
</figure>

**ZigBee**则面向更低功耗、更低速率的应用，如传感器、智能开关、安防设备等。其数据速率仅为 20–250 kbps，但功耗极低，适合电池供电设备长期运行。ZigBee 网络包含两类设备：  
- **全功能设备**：可担任协调器或路由器；  
- **简化功能设备**：只能作为终端，与全功能设备通信。  

ZigBee 支持多种拓扑，包括星型、树型和**网状网络**，后者可实现多跳路由，提升覆盖范围。其协议机制融合了多种已有技术：  
- 使用**信标帧**划分超帧，包含活跃期（用于通信）和非活跃期（设备休眠以省电）；  
- 支持 **CSMA/CA** 随机接入和**时隙预留**（类似 DOCSIS），兼顾灵活性与可靠性；  
- 采用**链路层确认**，确保关键数据可靠传输。

## 蜂窝因特网接入
在前一节中，我们讨论了设备在 802.11 接入点附近如何接入互联网。然而，Wi‑Fi 热点的覆盖范围通常只有 10 到 100 米，当用户身处室外或移动途中时，往往无法依赖 Wi‑Fi 接入。

为解决覆盖范围受限的问题，蜂窝网络（如 4G/5G）提供了一种更广泛的无线接入方式。最初，蜂窝网络主要用于语音通话和短信服务，但随着技术发展，它们逐渐被用于互联网接入，而不仅限于语音通信。这类接入在理想情况下应具备较高的数据速率，并支持**无缝移动性**，即使用户在汽车或火车上，也能保持 TCP 连接，甚至进行视频会议。随着宽带蜂窝数据技术的普及，传输速率已从每秒数 Mbps 提升至更高水平。

人们通常根据技术演进的阶段，将蜂窝网络划分为若干“代”，以反映每一代在通信能力、数据速率、网络架构以及服务类型上的显著提升与差异：

- **1G**：最早的模拟系统，仅支持语音，现已基本淘汰；
- **2G**：以 GSM 为代表的数字系统，最初专为语音设计，后来通过 **2.5G** 引入了基础数据服务；
- **3G**：在支持语音的同时，更注重提升数据速率，支持移动互联网；
- **4G**：基于 LTE 的全 IP 架构，统一承载语音与高速数据，提供数 Mbps 乃至更高的传输速率，实现真正的“语音即数据”。
- **5G**：进一步提升移动宽带速度、降低延迟，并支持大规模物联网连接，推动超高清视频、增强现实等新兴应用。

这一演进清晰地反映了蜂窝网络从**纯语音通信**向**高速移动互联网接入**的根本转变。

本节将简要介绍当前的蜂窝互联网接入技术。与 Wi-Fi 类似，我们重点关注**用户设备与基站之间的无线连接**，以及该连接如何接入更广泛的电话网和互联网。关于移动过程中如何保持通信连续性（例如跨基站切换和路由管理），将在后续章节进一步讨论。

在描述蜂窝网络架构时，本节将采用**全球移动通信系统**（GSM）的术语，其缩写源自法语。GSM 是 20 世纪 80 年代由欧洲为统一并取代多种互不兼容的模拟蜂窝系统而制定的数字标准，并于 90 年代初成功部署。凭借其开放性和互操作性，GSM 迅速成为全球主流，一度覆盖全球 80% 以上的移动用户。

### 2G：语音与电话网连接
“蜂窝”一词源于网络覆盖区域被划分为多个称为**小区**的地理单元，小区通常呈六边形，如下图所示。每个小区由一个**收发基站**（Base Transceiver Station, BTS）提供无线信号覆盖。小区的实际范围受基站发射功率、用户设备性能、建筑物遮挡以及天线高度等因素影响。在现代网络中，一个 BTS 通常位于三个小区的交界处，通过定向天线同时服务这三个小区，从而提高频谱和资源利用效率。

<figure style="text-align: center;">
<img src="/illustrations/计网笔记7/4.png" alt="2G 蜂窝网体系结构" width="80%">
<figcaption>2G 蜂窝网体系结构</figcaption>
</figure>

GSM 采用 FDM 与 TDM 结合的无线接入方式：频谱被划分为多个 200 kHz 的频段，每个频段内又按帧和时隙划分时间，可支持 8 个并发通话，语音编码速率约为 12–13 kbps。

多个 BTS 由一个**基站控制器**（Base Station Controller, BSC）统一管理。BSC 负责分配无线信道、定位用户（寻呼）、执行基站切换等任务。BSC 与其管辖的 BTS 共同构成了**GSM 基站系统**（Base Station System, BSS）。

更高层的**移动交换中心**（Mobile Switching Center, MSC）则负责用户鉴别和账户管理、呼叫建立、计费和移动性管理。一个 MSC 通常管理多个 BSC，可服务约 20 万用户。多个 MSC 组成运营商的核心网络，并通过**网关 MSC** 连接到公共电话网和互联网。

这种分层架构使蜂窝网络既能高效利用无线资源，又能支持大规模用户移动和通信。

### 3G：将因特网扩展到蜂窝用户
2G 网络最初主要用于语音通话，但随着用户需求的变化，数据服务（如收发邮件、浏览网页、使用地图或观看视频）变得更加重要。为实现这些功能，智能手机需要运行完整的 **TCP/IP 协议栈**，并通过蜂窝网络接入互联网。

蜂窝数据技术的发展历程十分复杂：从 2.5G、3G 到 4G，各种标准和缩写层出不穷，且缺乏统一规范，容易让人困惑。为理清主线，我们聚焦于由**第三代合作伙伴计划**（3GPP）主导的**通用移动通信系统**（UMTS）系列标准，包括其 3G 和 4G（LTE）演进版本。

接下来，我们将自上而下地介绍 3G 蜂窝数据网络的基本架构，其体系结构如下图所示。
<figure style="text-align: center;">
<img src="/illustrations/计网笔记7/5.png" alt="3G 蜂窝网体系结构" width="80%">
<figcaption>3G 蜂窝网体系结构</figcaption>
</figure>

1. 3G 核心网
3G 蜂窝数据网络的核心任务是将无线接入网连接到公共互联网。为了充分利用已有的语音网络基础设施（如 MSC），3G 设计时选择保留原有的电路交换语音核心网，同时在旁边并行构建一套独立的分组数据核心网。这样既保护了既有投资，又避免了类似 IPv4/IPv6 过渡所带来的兼容性问题。

这套数据核心网包含两类关键节点：

- **服务 GPRS 支持节点**（SGSN）：负责管理其覆盖区域内移动设备的数据收发。它与语音网中的 MSC 协同工作，处理用户认证、位置跟踪和基站切换，并在无线接入网与核心网之间转发数据。
- **网关 GPRS 支持节点**（GGSN）：负责 3G 网络与外部互联网之间的**网关功能**。所有来自移动设备的数据在进入互联网前，都会先经过 GGSN。对于外部网络而言，GGSN 就像一台普通路由器，移动设备的切换和位置变化对互联网完全透明，移动性被 GGSN 屏蔽在核心网内部。

> 注：通用分组无线服务（General Packet Ratio Service, GPRS）最初是 2G 网络中的数据技术，3G 中的 SGSN/GGSN 是其演进版本，用于支持更高速率的分组数据业务。
2. 3G 无线电接入网
3G 无线接入网是用户设备直接连接的**无线接入部分**，由多个基站（在 3G UMTS 中称为 **Node B**）和一个**无线网络控制器**（Ratio Network Controller, RNC）组成。RNC 管理多个小区的无线资源，其功能类似于 2G 网络中的 BSC。

每个小区的无线链路将移动设备与 Node B 连接起来。需要注意的是，3G 的语音和数据服务虽然分别使用不同的核心网（语音通过电路交换，数据通过分组交换），但它们仍然共享同一套无线接入网。事实上，RNC 既负责通过 MSC 接入语音网络，又负责通过 SGSN 连接到互联网。

与 2G 使用的 FDMA/TDMA 不同，3G UMTS 采用**直接序列宽带码分多址**（Direct Sequence Wideband CDMA, DS-WCDMA）技术，在传统的频分和时分基础上叠加 CDMA，实际上同时运用了频分、时分和码分三种信道共享方式。这种设计显著提升了频谱利用率和数据速率。基于 WCDMA 的增强技术称为**高速分组接入**（HSPA），下行速率可达 14 Mbps，为移动互联网的高效体验奠定了基础。

### 4G：LTE
4G 蜂窝系统已经在全球广泛部署。与 3G 相比，其两大关键创新在于**全 IP 核心网**和**增强型无线接入网**。体系结构如图所示：
<figure style="text-align: center;">
<img src="/illustrations/计网笔记7/6.png" alt="4G 蜂窝网体系结构" width="80%">
<figcaption>4G 蜂窝网体系结构</figcaption>
</figure>

1. 4G 体系结构：全 IP 核心网  
   3G 网络对语音和数据使用两套独立路径，语音通过电路交换，数据通过分组交换，而 4G 完全统一了业务处理，语音和数据都通过 IP 网络以分组交换的方式传输，实现了蜂窝网络从传统电话网络向纯 IP 网络的转型。

   4G 网络清晰区分了**数据平面**和**控制平面**。数据平面负责用户数据的转发，例如从用户设备（UE）经 eNodeB、服务网关（S-GW）到分组数据网络网关（P-GW），最终进入互联网。控制平面则处理信令事务，包括用户在不同小区之间移动时的**切换**，以及在终端接入网络时验证其身份与权限的**鉴权**。这些功能主要由移动管理实体（MME）和归属用户数据库（HSS）承担，从而将业务数据传输与网络控制流程严格分离，提高了网络的可扩展性与管理效率。

   此外，用户设备与 P-GW 之间通过 **IP 隧道**传输数据，这保证了设备在移动过程中 IP 地址保持不变、连接持续。然而，这个内部 IP 在不同条件下可能会变化，例如重新附着到网络或会话超时时可能重新分配。同时，设备的公网 IP 通常随时间变化，不会固定。因此，移动网络通过 IP 隧道机制在保证内部会话连续性的同时，灵活管理公网地址。这样的设计不仅简化了网络架构，也为高质量移动互联网应用（如视频通话和实时交互服务）奠定了基础。

   下面详细介绍 4G 网络的主要组成部分：  
   -  **eNodeB**：可以看作 2G 基站和 3G NodeB 的继承者，在 4G 中继续发挥核心作用。它负责在 UE 和 P-GW 之间转发用户数据。来自 UE 的数据报会在 eNodeB 中被封装，并通过 LTE 无线接入网进入全 IP 强化分组核。eNodeB 与 P-GW 之间的数据以隧道的方式传输，这与 IPv6 数据报在 IPv4 网络中进行隧道转发的方式类似。隧道承载的业务通常与服务质量保证相关。
   - **分组数据网关**（Packet Data Network Gateway, P-GW）：4G 网络的出口，连接外部互联网。P-GW 负责给 UE 分配 IP 地址，并根据业务类型执行服务质量策略，例如保证语音业务的低延迟和低丢包。
   - **服务网关**（Service Gateway, S-GW）：数据平面的移动性锚点。无论用户切换到哪个基站，S-GW 都负责保持 UE 与 P-GW 之间的隧道，并在切换时将隧道入口从旧基站更新到新基站，使数据流向能在不断开连接的情况下自动重路由。这样即使用户高速移动，也能让 IP 地址保持不变，会话保持持续。S-GW 同时支持计费和合法监听等业务。
   - **移动性管理实体**（Mobility Management Entity, MME）：负责处理 UE 的注册、认证和位置更新等控制平面任务。
   - **归属用户服务器**（Home Subscribe Server, HSS）：存储用户签约信息，如权限、QoS 配置和鉴权数据。
2. LTE 无线接入网
   LTE 的下行链路采用正交频分复用（OFDM）技术，即使用大量彼此正交的窄带子载波并行承载数据，可以视为频分复用与时分复用的结合。所谓“正交”，指的是各子载波虽然在频谱上紧密相邻甚至部分重叠，但由于满足数学上的正交条件，因此彼此之间几乎不会产生干扰。

   在 LTE 中，时间被划分为 **0.5 毫秒的时隙**，频谱被划分为多个子载波。网络可为每个活跃用户动态分配**一个或多个时隙**，并在**一个或多个频率**上进行传输。通过增加分配的时隙数量或使用更高阶调制（如从 QPSK 切换到 64-QAM），系统可灵活提升用户的数据速率。

   资源分配由 eNodeB 中的**调度器**每毫秒进行一次。调度策略通常基于：
   - **信道质量**：优先为信号条件好的用户分配资源（称为“机会调度”），以提升整体频谱效率；
   - **服务等级**：支持按优先级（如普通、金、铂金）保障不同用户的 QoS。

   此外，**LTE-Advanced** 引入了**载波聚合**技术，可将多个频段捆绑使用，实现数百 Mbps 的下行速率。

   值得一提的是，另一种 4G 技术 **WiMAX**（基于 IEEE 802.16）也曾被提出，但在全球部署规模远不及 LTE，目前已基本退出主流市场。

## 移动管理原理
在理解了无线网络中通信链路的无线特性后，我们继续关注另一个关键问题：移动性。所谓移动性，是指用户在改变接入位置时，网络如何保持连接的连续性。从网络层的角度，移动性可以分为不同层次：用户可能在建筑物内走动，但始终连接同一个接入点，此时 IP 地址不变，网络层并不会感知移动；也可能从一个地点移动到另一个地点，断开原网络后重新连接新网络，并通过 DHCP 获取新的 IP 地址；更高要求的场景则是用户在高速移动中穿越多个网络，却希望保持正在进行的 TCP 会话不中断。

是否需要在移动中保持同一个 IP 地址，取决于应用类型。对于网页浏览、收邮件等短连接服务，重新获取 IP 地址通常没有问题；但对于视频通话、在线游戏、远程控制等持续连接的应用，一旦 IP 地址变化，连接就会中断，因此对上层保持一个稳定地址具有重要价值。

为支持这一需求，引入了几个核心概念。**归属网络**是设备永久注册的网络，移动节点的永久 IP 地址就属于这个子网，其中的**归属代理**负责记录设备的当前位置，并将发往该设备的数据转发到它当前所在的网络。设备临时接入的网络称为**外部网络**，在外部网络中负责移动管理的实体称为**外部代理**。与移动设备通信的另一方称为**通信者**。通过这些机制，设备可以在跨越不同网络时保持连接连续性，确保数据在移动过程中始终能够送达。

<figure style="text-align: center;">
<img src="/illustrations/计网笔记7/7.png" alt="移动网络体系结构的各种概念" width="80%">
<figcaption>移动网络体系结构的各种概念</figcaption>
</figure>

需要说明的是，这些机制通常假设存在固定的网络基础设施，如 Wi-Fi 接入点或蜂窝基站。如果没有基础设施（例如在野外仅靠设备之间直接通信），则需要依赖自组织网络（MANET），这是另一类更前沿的研究方向，不属于本章的重点。

总体来看，移动性的核心并不只是“在哪里能连上网”，而是在移动过程中如何让连接保持连续、地址保持一致。这正是移动 IP 以及现代蜂窝系统（如 4G/5G 所采用的移动管理技术）真正要解决的问题。

### 寻址
为了让移动性对上层应用透明，理想状态是移动节点在切换网络时仍保持其**永久 IP 地址不变**，但当它接入外地网络时，发往该地址的数据就会面临无法直接送达的问题。一种直观的解决办法是由外地网络向整个互联网广播一条特殊路由，声明自己能够到达该移动节点的永久地址，使其他路由器依靠常规路由协议将数据正确转发过去；当节点离开时撤销该路由，在新的接入网络中再发布新的路由。这样虽然概念上可行，但可扩展性极差，因为若有大量设备频繁移动，核心路由器将不得不维护并更新海量的特定路由表项，整体网络无法承受这种负担。

因此，实际系统并不让移动性在全网范围内传播，而是将移动性管理收敛到网络边缘，由移动节点的归属网络负责维护其位置。归属网络中的归属代理会记录移动节点当前所处的外地网络，并据此执行数据的转发和位置更新，从而避免在核心路由器中维护海量的移动相关路由信息。

为实现这一点，外地网络为移动节点引入了一个额外的临时地址，即**转交地址**（Care-of Address, CoA）。移动节点始终保留一个用于标识身份的**永久地址**，而在外地网络中则通过 DHCP 等机制获取一个反映当前位置的转交地址。归属代理记录并维护永久地址与转交地址之间的映射，使得数据在节点移动时仍能准确送达。

在外地网络中，**外部代理**通常部署在边缘路由器上，负责为移动节点分配 CoA 并将其通知归属代理。随后，发往移动节点永久地址的数据首先到达归属代理，再由归属代理通过**隧道转发**至 CoA，最终送达移动节点，从而实现跨网络的无缝通信。现代设备通常**自行承担外部代理功能**，直接获取 CoA 并主动向归属代理注册，无需依赖外地网络的专用代理。

### 路由选择到移动节点
当移动节点获得 CoA 并向归属代理注册后，仅让归属代理知道其当前位置还不足以保证数据的正确传递，因为网络中的其他路由器并不知道移动节点已经离开归属网。如果仍将数据报按照移动节点的永久地址投入网络，它将只会被正常路由到归属网络，而无法到达实际所在的被访网络。因此，移动 IP 需要额外的转发机制来确保数据能够送达移动节点。目前主要有两种方式：间接路由选择由归属代理在归属网络截获发往移动节点永久地址的数据报，并通过隧道转发到其 CoA；直接路由选择则让通信对端或其网关在得知绑定关系后绕过归属代理，将数据报直接发送到移动节点的 CoA。这两种机制共同解决了移动节点地址不变但位置可变所带来的路由问题。

1. 移动节点的间接路由选择
   在**间接路由**机制中，通信方只需将数据报发送到移动节点的**永久地址**，无需知道它当前处于哪个网络，移动性对通信方完全透明。数据报会首先按照正常的路由流程到达移动节点所属的**归属网络**，由**归属代理**处理这些发往外出的节点的数据。归属代理会截获目的地址属于本节点但当前已移动出去的数据报，然后将其封装进新的 IP 包中，外层目的地址设置为移动节点当前的 CoA。封装后的包被送往移动节点所在的外地网络，由外部代理接收并解封装，还原出原始数据报后再交付给移动节点。整个流程如图所示：
   <figure style="text-align: center;">
   <img src="/illustrations/计网笔记7/8.png" alt="移动节点的间接路由选择" width="80%">
   <figcaption>移动节点的间接路由选择</figcaption>
   </figure>

   这种“封装、转发、再解封装”的过程本质上就是一种**隧道**机制。它的做法是在原始数据报外再加上一层新的 IP 头，使这个外层包能够根据新的目的地址在网络中被正确路由，而内部的原始数据报保持原样不变。到达目标网络后，外层包被移除，内部的数据报再按照它自己的目的地址继续向前转发。通过这种方式，隧道在网络中构建了一条逻辑上的“虚拟路径”，既能让数据沿着指定方向传输，又不会影响原始数据的内容与意义。

   当移动节点向通信方发送数据时，流程更加直接。它依旧以自己的永久地址作为源地址，将数据报按正常路由发送出去，无需经过归属代理，也不需要额外的封装过程。

   为了支持间接路由，移动 IP 需要增加一系列新的功能。当移动节点接入外地网络时，它会通过**移动节点到外部代理的协议**向外部代理登记自己的转交地址，离开该网络时则会取消注册。外部代理随后通过外部代理到归属代理的**注册协议**，将移动节点的转交地址报告给归属代理。归属代理据此维护移动节点最新的位置，并在收到发往该节点永久地址的数据报时，通过**数据报封装协议**将原始数据报封装进一个新的 IP 包，并把外层目的地址设置为转交地址。封装后的数据到达外地网络后，由外部代理通过**拆封协议**移除外层 IP 头，取出原始数据报并交付给移动节点。

   移动过程中不可避免会有短暂中断，但通常不会影响连接。移动节点在切换到新的外地网络时，会先离开原网络再接入新网络，在这一间隙发往旧转交地址的数据可能会丢失。不过，只要切换过程足够快，丢包数量往往很小。由于上层协议（例如 TCP）天然具备处理丢包和重传的能力，这些短暂的损失不会导致连接中断；对可靠性要求特别高的应用也可以依赖已有的重传机制来恢复数据。
2. 移动节点的直接路由选择
   在间接路由机制中，所有发往移动节点的数据都必须先抵达其归属代理，再由归属代理转发到移动节点当前所在的外地网络，这会带来所谓的**三角路由问题**：即便通信双方实际上位于同一个外地网络，数据也必须绕行归属网络才能抵达对方，造成额外的路径延长、时延增加以及带宽浪费。

   直接路由的目标是避免三角路由，使通信方能够直接向移动节点当前的 CoA 发送数据，从而缩短路径并提高效率。在这种方式下，通信者所在网络中的**通信者代理**负责获取移动节点最新的 CoA，它会向归属代理发起查询，前提是移动节点已在归属代理处完成注册。通信者本身也可能承担这一代理功能。在获得 CoA 之后，通信者代理使用隧道技术将数据报直接发送到该地址，其过程与间接路由中归属代理执行的隧道机制类似。整个流程如图所示：

   <figure style="text-align: center;">
   <img src="/illustrations/计网笔记7/9.png" alt="移动节点的直接路由选择" width="80%">
   <figcaption>移动节点的直接路由选择</figcaption>
   </figure>
   
   要支持直接路由，通信方（或其代理）必须能够从归属代理查询移动节点的最新 CoA，因此必须依赖专门的**移动用户定位协议**；而移动节点在切换到新网络后，其 CoA 会随之改变，若通信方继续使用旧地址，通信将无法进行。因此，直接路由必须配套可靠的**地址更新机制**，确保通信方在整个会话期间始终掌握当前有效的 CoA。

   在实际部署中，为降低直接路由的复杂性，有时会引入**锚外部代理**作为折中方案。当会话开始后移动节点首次进入某个外地网络时，该网络的外部代理被设为“锚”，成为数据的固定入口点。此后，无论节点移动到哪个新网络，移动节点向新的外部代理注册，并且新的外部代理向锚外部代理提供移动节点的新 CoA。外部通信的数据先发送到锚代理，再由锚代理根据最新 CoA 将数据二次转发到移动节点当前所在网络。这样既保留了直接路由的效率优势，又避免通信方频繁查询最新 CoA 带来的开销。

   <figure style="text-align: center;">
   <img src="/illustrations/计网笔记7/10.png" alt="锚外部代理" width="80%">
   <figcaption>锚外部代理</figcaption>
   </figure>

   这种方式避免了频繁通知所有通信方，同时减少了对核心网络的改动。类似机制已在 GSM 等实际移动通信系统中采用。

总之，间接路由简单但低效，直接路由高效但复杂。实际系统常在二者之间权衡，通过锚点、隧道和注册机制，在移动性、效率与可扩展性之间取得平衡。