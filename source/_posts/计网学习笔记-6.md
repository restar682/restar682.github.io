---
title: 计网学习笔记-6
date: 2025-11-08 11:51:42
categories: 计网
description: 《计算机网络——自顶向下方法》第六章学习笔记。
tags: [计算机网络, 链路层, 局域网]
---
# 链路层
## 链路层概述
### 链路层服务
链路层的基本服务是将数据报通过单一通信链路从一个节点移动到相邻节点，但所提供的服务细节会随着链路层协议的不同而有所变化。链路层能够提供的可能服务包括：

1. **成帧**
   在网络层数据报通过物理链路传输之前，几乎所有的链路层协议都会将其封装在链路层帧中。一个帧通常由一个数据字段和若干首部字段组成，其中网络层数据报被置于数据字段内，其余结构如首部和可能的尾部则由具体的链路层协议定义。
2. **链路接入**
   链路接入由媒体访问控制（Medium Access Control, MAC）协议规定，用于管理帧在共享链路上的传输规则。
   - 对于点对点链路，即链路一端仅有一个发送方，另一端仅有一个接收方，MAC 协议通常非常简单，甚至可以省略：只要链路空闲，发送方即可立即发送帧。
   - 更复杂的情形出现在多个节点共享同一广播链路的场景，即多路访问问题。此时，MAC 协议的作用是协调多个节点对链路的访问，防止帧冲突并确保有序传输。
3. **可靠交付**
   某些链路层协议提供可靠交付服务，即保证每个网络层数据报都能无差错地通过链路层传输。这与运输层如 TCP 的可靠交付机制类似，通常通过确认 ACK 和重传机制实现。
   链路层的可靠交付主要用于高误码率的链路，如无线链路，其优势在于能够在错误发生的本地链路上及时纠正，避免触发端到端的重传，从而提升效率。
   然而，在误码率极低的有线链路，如光纤、同轴电缆或高质量双绞线，链路层可靠交付往往被视为不必要的开销。因此，许多现代有线链路层协议如以太网并不提供此项服务。
4. **差错检测与纠正**
   由于信号衰减和电磁干扰，帧在传输过程中可能出现比特错误。为了避免转发含错的数据，大多数链路层协议都包含差错检测机制。
   具体实现方式是：发送方在帧中附加差错检测比特，如 CRC 校验码，接收方则利用这些信息验证帧的完整性。与网络层和运输层使用的简单校验和如 IP 或 TCP 校验和相比，链路层的差错检测通常更强大，并由硬件高效实现。
   差错纠正则更进一步，不仅能够检测错误，还能定位并修正帧中的错误比特。不过，差错纠正机制较为复杂，通常仅在特定高误码环境中使用，如卫星或深空通信。

### 主机的网络层和链路层
与路由器不同，主机既不参与分组转发，也不承担网络中继功能，因此其网络层和链路层的实现均围绕“端系统通信”这一目标设计，从而与路由器存在显著差异。

- **网络层**完全由操作系统中的软件实现，运行在主机的主 CPU 上。它仅负责构造或解析本机收发的 IP 数据报，不执行任何转发操作。
- **链路层**则主要实现在**网络适配器**（即网卡）中。适配器的核心是链路层控制器，它通常是一个实现了多种链路层服务的专用芯片，以硬件方式高效完成成帧、链路接入、差错检测等底层操作。不过，链路层并非纯硬件实现，诸如设置帧头地址、触发发送、处理接收中断等高层控制逻辑，仍由运行在主机 CPU 上的驱动程序中完成。

因此，主机的链路层是**硬件与软件的结合体**：硬件处理高频、时序敏感的底层任务，软件则负责与操作系统及上层协议栈的交互。这种协同设计在保证性能的同时，也保留了必要的灵活性。

相比之下，路由器的网络层和链路层都面向转发优化，链路层实现在线路卡的专用硬件中，网络层也常由硬件加速以实现高效转发。而主机的协议栈则专注于端到端通信，网络层纯软件、链路层软硬协同，两者设计目标与实现方式迥然不同。

## 差错检测和纠正技术
为了保护要传输的数据，发送端会在原始数据 $D$（包括网络层数据报和链路层首部中的地址、序号等字段）后附加一组**差错检测与纠正比特**（Error-Detection and Correction, EDC）。整个组合（$D$ 加上 EDC）构成一个完整的帧，被发送到接收端。

在接收端，收到的是可能因传输错误而改变的版本 $D'$ 和 $EDC'$。接收方的任务是根据 $D'$ 和 $EDC'$，判断原始数据 $D$ 是否在传输中发生了差错。

需要特别注意的是：我们关心的是“**是否检测到差错**”，而不是“**是否发生了差错**”。因为差错检测机制并不能保证发现所有错误，即使使用了 EDC，仍可能存在**未检出差错**，即接收方误以为数据正确，并将其交付给上层。为此，我们选择的差错检测方案应使这类事件的概率极低。

通常，差错检测或纠正能力越强（即未检出错误的概率越小），所需的 EDC 比特越多，计算开销也越大。因此，实际设计需在可靠性与效率之间取得平衡。

### 奇偶校验
最简单的检测手段是**奇偶校验**。假设要发送的数据 $D$ 包含 $d$ 个比特。在**偶校验**方案中，发送方附加一个校验比特，使得整个 $d+1$ 比特（数据加校验位）中“1”的总数为偶数；奇校验则使“1”的总数为奇数。接收方只需统计收到的 $d+1$ 比特中“1”的个数即可。如果使用偶校验却得到奇数个“1”，说明传输中发生了奇数个比特错误，差错可被检测到。

但这种方法有一个明显缺陷。如果发生偶数个比特错误，奇偶校验将无法察觉。如果我们假设比特错误概率低且相互独立，那么多比特错误很少见，但实际链路中的错误常以“突发”形式出现（多个相邻比特同时出错），此时单比特奇偶校验的漏检率可能高达 $50\%$。因此，我们需要更可靠的机制。

一种自然的改进是**二维奇偶校验**。通过将数据比特排列成一个$ i$ 行 $j$ 列的矩阵，并且对每一行和每一列分别计算奇偶校验位，可以增强检验能力。这种方案不仅能检测多个比特错误，还能纠正单个比特错误。当某一位出错时，其所在行和列的校验都会失效，接收方通过交叉定位即可确定出错位置并修正。此外，二维奇偶校验还能检测任意两个比特的错误，但不能纠正。

这种在接收端直接纠正错误的能力称为**前向纠错**（Forward Error Correction, FEC）。FEC 的优势在于无需请求重传，避免了等待重传所需的往返时延，特别适用于实时应用或高延迟链路（如卫星通信）。在实际网络中，FEC 既可以单独使用，也可与基于确认/重传的链路层 ARQ 机制（ARQ 机制和可靠数据传输原理类似）结合，以兼顾效率与可靠性。

### 检验和方法
稍微复杂一些的差错检测方法是**检验和技术**。其做法是将数据划分为若干固定长度的整数（如 16 位），发送方对这些整数求和并取反码，将结果作为检验和字段。第三章介绍的 UDP 检验和正是采用这一机制。接收方收到数据后，将所有字段（包含检验和）再次相加并取反码；若结果不是全 1，则说明传输过程中出现了差错。

检验和的计算代价很低，例如 TCP 和 UDP 只使用 16 比特的简单加法反码校验。相比之下，链路层常用的**循环冗余校验**（Cyclic Redundancy Check, CRC）能够提供更强的差错检测能力，但其按位移位和异或的运算模式在通用 CPU 上难以并行加速，软件实现开销明显更高。由于运输层的校验由主机 CPU 的软件执行，必须采用轻量级、易于流水化的操作，因此选择了简单的检验和；而链路层的 CRC 则由网卡内的专用硬件电路完成，几乎不增加额外成本，却能高速处理复杂运算，从而提供更强的保护。

因此，检验和适合软件快速处理，CRC 适合硬件高效实现，两者的选择反映了不同协议层对性能与可靠性的权衡。

### 循环冗余检验
如今在网络中广泛使用的差错检测技术基于 CRC 编码，也被称作多项式编码，因为该编码将要发送的比特串看作系数为 0 和 1 的一个多项式，对比特串的操作被视作多项式算术。

CRC 的基本思想是：发送方将待发送的 $d$ 比特数据 $D$ 附加 $r$ 个校验比特 $R$，使得组合后的 $d+r$ 比特序列能被一个双方预先约定的 $r+1$ 比特生成多项式 $G$（最高位为 1）整除（使用模 2 除法，即无进位、无借位的二进制除法）。

接收方收到数据后，用同样的 $G$ 去除整个 $d+r$ 比特序列。如果余数为 0，认为无差错；否则，判定发生了传输错误。

所有 CRC 运算基于模 2 算术，因此加法和减法等价于按位异或 XOR。例如：

$$1011 \oplus 0101 = 1110$$

校验比特 $R$ 的计算方法很简单：将原始数据 $D$ 左移 $r$ 位，即 $D \cdot 2^r$，再用 $G$ 做模 2 除法，所得余数即为 $R$。

一个广泛使用的标准是 CRC-32，其生成多项式为 32 位，在以太网等 IEEE 链路层协议中被采用。这类 CRC 能检测：

- 所有长度不超过 32 比特的突发差错；
- 所有奇数个比特的错误；
- 更长突发差错的被检出概率也高达 $1 - 0.5^{32}$，几乎可以视为可靠。

由于 CRC 运算规则固定且适合并行处理，现代网卡通常用专用硬件高效实现，因此链路层普遍采用 CRC 而非更简单的检验和。

## 多路链路访问协议
如前所述，网络链路可以分为点对点链路和广播链路。许多链路层协议为点对点链路设计，如点对点协议（point-to-pointprotocol, PPP）和高级数据链路控制（high-level data link control, HDLC）。广播链路则允许多个节点共享同一个通信信道：当任一节点发送一个帧时，该帧会被信道广播，所有其他节点都能接收到。以太网就是一种典型的广播链路技术。

需要注意的是，链路层的广播能力常被上层协议所利用。例如，IP 层的**受限广播**在本地网络中发送时，就依赖链路层广播机制（如以太网的 MAC 广播地址）将数据报送达同一链路上的所有主机。但受限广播属于网络层概念，其作用范围仅限于本地网络，且由路由器阻断，与链路层的广播信道本身属于不同层次。

本节聚焦于广播链路中多个节点对共享信道的协调访问，即**多路访问问题**。由于广播信道广泛用于局域网，我们也将简要探讨多路访问机制在局域网中的实际应用。

由于广播链路上的所有节点都能发送帧，多个节点可能同时传输。当这种情况发生时，这些帧在所有接收方处相互干扰，即发生**碰撞**。碰撞会导致所有相关帧无法被正确接收，信号彼此混叠，造成传输失败。相应地，碰撞期间的信道时间被浪费。如果多个节点频繁发送，碰撞将大量发生，导致信道带宽严重浪费。

因此，当多个节点处于活跃状态时，必须通过某种方式协调它们的传输，以确保信道有效工作。这一任务由**多路访问协议**完成。尽管已提出众多多路访问协议，但基本可归为三类：**信道划分协议**、**随机接入协议**和**轮流协议**。接下来的三小节将分别介绍这三类协议。

理想的多路访问协议应具备以下几个关键特性（假设广播信道速率为 $R$ bps）：

1. **单节点效率**：当只有一个节点发送时，其吞吐量应达到 $R$ bps；  
2. **公平共享**：当有 $M$ 个节点同时发送时，每个节点应获得平均 $\frac{R}{M}$ bps 的吞吐量（不要求瞬时速率恒定，但长期平均应满足）；  
3. **去中心化**：协议不应依赖单一主控节点，避免单点故障导致系统失效；  
4. **实现简单**：协议应结构简洁，便于低成本实现。

### 信道划分协议
在最初讨论网络核心的电路交换时，我们就提到时分多路复用（TDM）和频分多路复用（FDM）这两种用于在所有共享信道的节点之间划分广播信道带宽的技术，现在看来，他们毫无疑问属于信道划分协议。

TDM 将时间划分为周期性的帧，每个帧再分为 $N$ 个时隙，分别分配给 $N$ 个节点。当某个节点有数据要发送时，只能在分配给它的固定时隙内传输。这种方式完全避免了碰撞，并保证每个节点获得平均 $R/N$ bps 的带宽。但其缺点也很明显：即使只有一个节点有数据发送，它仍被限制在 $R/N$ 的速率，并且必须等待轮到自己的时隙，造成带宽浪费和延迟。

FDM 则将信道的总带宽 $R$ 划分为 $N$ 个互不重叠的频段，每个节点独占一个频段。和 TDM 类似，FDM 也消除了碰撞并实现公平分配，但也同样存在带宽僵化的问题：节点无法在空闲时利用其他节点未使用的频段，导致效率低下。

第三种信道划分方式是**码分多址**（Code Division Multiple Access, CDMA）。与 TDM 和 FDM 不同，CDMA 不划分时间或频率，而是为每个节点分配唯一的编码。所有节点可同时使用整个信道带宽，通过编码区分彼此。若编码设计得当，接收方能从混合信号中正确提取目标发送方的数据，即使其他节点同时在传输。CDMA 具有良好的抗干扰能力，常用于无线通信。由于其与无线信道密切相关，具体细节将在后续章节讨论。目前只需理解：CDMA 通过编码实现信道共享，是另一种形式的信道划分。