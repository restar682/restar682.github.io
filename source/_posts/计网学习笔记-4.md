---
title: 计网学习笔记-4
date: 2025-11-02 23:55:43
categories: 计网
description: 《计算机网络——自顶向下方法》第四章学习笔记。
tags: [计算机网络, 网络层]
---
# 网络层：数据平面
在网络中，每台主机和路由器都包含网络层的功能模块。也正因如此，网络层协议是整个协议栈中最为复杂且最富挑战性的部分。通常来说，网络层可以被划分为**数据平面**和**控制平面**：数据平面负责决定数据报如何被转发，而控制平面则负责确定路由策略。在第四章中，我们主要学习**数据平面**的相关内容。

## 网络层概述
### 转发和路由选择
网络层的作用表面上极为简单，就是将分组从一台发送主机传输到另一台接收主机。然而，要实现这一目标，网络层需要依赖两种核心功能：

- **转发**：当一个分组到达路由器的某条输入链路时，路由器需将其移至合适的输出链路。转发是**数据平面**所实现的唯一功能。在某些情况下，分组也可能被路由器丢弃，例如来自已知恶意主机的流量，或目的地址属于被禁止访问的主机。
- **路由选择**：当分组从发送方流向接收方时，网络层需确定其所采用的路由（或路径），用于计算这些路径的算法称为**路由选择算法**。路由选择功能由**控制平面**实现。

路由器中一个至关重要的组件是**转发表**。当一个分组到达路由器时，路由器会检查该分组首部中的一个或多个字段，并利用这些字段的值作为关键字在转发表中进行查找。转发表中的每一项通常包含匹配条件和对应的输出链路，路由器根据匹配结果确定该分组应从哪条输出链路转发出去。

转发表的配置方式主要有两类：**传统分布式方法**和**软件定义网络**（Soft-ware-Defined Networking, SDN）。在传统网络中，每台路由器既负责数据平面的转发，也运行控制平面的路由协议，通过与其他路由器交换网络状态信息，自主计算路由并本地生成转发表，控制与数据功能紧密耦合于同一设备。而在 SDN 架构中，控制平面被集中化，由远程的 SDN 控制器统一计算路径并主动向各交换机或路由器下发转发表项，数据平面仅负责按表转发，从而实现**控制平面与数据平面的逻辑分离**。理论上，转发表甚至可以完全由人工静态配置（例如通过命令行设置静态路由），无需动态协议参与，这进一步说明转发行为本身并不依赖本地控制逻辑，因此控制与转发在功能上是可分离的。

### 网络服务模型
理论上，网络层可以提供多种多样的服务，例如：确保分组可靠交付、在限定时延内完成交付、保证分组有序到达、提供最小带宽保障，以及支持安全传输等。然而，正如我们在传输层中所讨论的，因特网的网络层仅提供一种服务：“尽力而为”服务，也就是说，因特网既不能保证端到端时延，也不保证有最小的带宽。这一术语听起来几乎像是“没有服务”的委婉说法。相比之下，其他网络体系结构（如ATM）确实实现了更强大的服务模型，提供明确的服务质量保证。尽管如此，因特网基于尽力而为服务辅以充足的带宽供给，已被实践证明“足够好”，足以支撑从网页浏览、视频流媒体到实时通信等极其广泛的应用场景。

## 路由器工作原理
路由器包含下图所示的四个组件：

<figure style="text-align: center;">
  <img src="/illustrations/计网笔记4/1.png" alt="路由器体系结构" width="90%">
  <figcaption>路由器体系结构</figcaption>
</figure>

- **输入端口**：输入端口是路由器中连接物理链路的硬件接口，承担了多项关键功能。其主要职责包括：  
  1. **物理层终结**：接收并解析来自入链路的物理信号，完成比特流到数字数据的转换（对应最左侧功能模块）；  
  2. **链路层处理**：与入链路远端设备协同完成数据链路层协议操作，如帧同步、差错检测、流量控制等（对应中间功能模块）；  
  3. **转发查找**：提取分组首部中的关键字段（如目的 IP 地址），在转发表中执行高速查找，确定对应的输出端口，并将分组送入交换结构。对于需要本地处理的控制分组（如路由协议报文），则将其转发至路由选择处理器（对应最右侧功能模块）。  
  在实际路由器中，输入端口的类型和数量差异很大，可支持从低速串行链路到高速光纤接口（如 100 Gbps 甚至更高）的广泛速率范围，以适应不同网络场景的需求。
- **交换结构**：交换结构负责将输入端口连接到它的输出端口。
- **输出端口**：输出端口负责接收来自交换结构的分组，将其暂存于输出队列中，并执行必要的链路层（如帧封装、差错编码）和物理层（如信号调制、时钟同步）功能，最终将分组通过输出链路发送出去。当通信链路为**双向**时，输入端口与输出端口通常成对集成在同一块**线路卡**上，共享物理接口资源，以提高硬件集成度和转发效率。
- **路由选择处理器**：在传统路由器中，该处理器负责运行路由选择协议，维护路由表及相关的链路状态或可达性信息，并据此生成转发表供数据平面使用。在 SDN 架构的路由器中，其不再本地计算路由，而是与远程 SDN 控制器通信，接收由控制器集中计算并下发的转发表项，并将这些表项安装到输入端口的转发硬件中。此外，路由选择处理器通常还承担网络管理功能。

路由器的输入端口、输出端口和交换结构几乎总是采用专用硬件实现，这是因为它们需要以极高的速度处理海量分组，转发决策通常必须在纳秒级完成，而通用软件处理难以满足如此严苛的性能要求。相比之下，路由选择处理器通常运行在通用计算机硬件和操作系统之上，其处理时延在毫秒量级即可接受，这使得路由器能够灵活地执行各种动态路由协议、响应网络拓扑变化，并支持丰富的网络管理功能。

### 输入端口处理和基于目的地的转发
下图展示了输入端口处理流程的更详细内容：
<figure style="text-align: center;">
  <img src="/illustrations/计网笔记4/2.png" alt="输入端口处理流程" width="70%">
  <figcaption>输入端口处理流程</figcaption>
</figure>

可以看到，输入端口的线路端接功能与链路层处理模块共同实现了各输入链路对应的物理层和数据链路层功能；随后，通过查询转发表确定相应的输出端口，使到达的分组经由交换结构被正确转发至目标输出端口。该转发表由路由选择处理器本地计算并更新，或在 SDN 架构下由远程控制器下发。为支持高速转发，转发表会通过独立总线从路由选择处理器复制到各线路卡（在路由器体系结构图中以虚线表示）。借助这些本地副本，每个输入端口可独立完成转发决策，无需调用路由选择处理器，从而显著提升转发效率。

最简单的情形是要为一个 32 位的 IP 地址进行转发。若采用暴力实现，转发表需包含多达 40 亿个条目，显然不可行。实际上，我们采用基于目的地址**前缀**的匹配方式，并遵循**最长前缀匹配**原则。

假设转发表已经存在，理论上只需遍历所有表项即可找到匹配项，但由于路由器的转发决策必须在**纳秒级**时间内完成，这种线性查找方式远远无法满足高性能转发的需求。因此，实际系统采用专门的**快速查找算法**（如基于 trie 的结构、哈希等）来高效实现最长前缀匹配。与此同时，为尽可能缩短内存访问延迟，系统通常采用分层存储策略：完整的转发表因其规模庞大，存储在大容量、低成本的 **DRAM** 中，由路由选择处理器负责维护；而频繁访问或近期使用的表项则被缓存在高速的 **SRAM** 中，供输入端口在纳秒级时间内完成高速查找，从而兼顾容量与转发性能。

一旦通过查找确定了某分组的输出端口，该分组便可送入交换结构。但如果此时交换结构正被其他分组占用，则该分组可能会被暂时阻塞，必须在输入端口处排队，等待后续被及时调度并通过交换结构。

尽管“查找”在输入端口处理中通常被视为最关键的操作，但实际上接收端口还需完成多项其他必要任务：
1. 必须执行物理层和链路层的处理（如前所述）；
2. 必须检查分组的版本号、首部校验和以及生存时间等字段（相关内容将在下一节讨论），并对校验和与 TTL 字段进行更新；
3. 还需更新用于网络管理的统计计数器（例如接收到的 IP 数据报总数）。

### 交换
交换结构负责连接输入端口与输出端口，但其实现方式多种多样。常见的交换技术如图所示：

<figure style="text-align: center;">
  <img src="/illustrations/计网笔记4/3.png" alt="常见交换技术" width="90%">
  <figcaption>常见交换技术</figcaption>
</figure>

- **经内存交换**：  
  分组由输入端口直接送入路由器的主内存，由路由选择处理器（或 CPU）读取分组首部、查找转发表，并将分组复制到对应输出端口的缓存中。这种方式结构简单、成本低，但受限于内存带宽和处理器速度，吞吐量较低，难以满足高速网络需求。
- **经总线交换**：  
  输入端口通过共享总线将分组直接发送至目标输出端口，无需经过主处理器或主内存。每个分组在总线上以带标签的形式广播，所有输出端口都能接收到该分组，但只有标签与自身地址匹配的输出端口才会接收并处理数据。这种方式虽避免了处理器瓶颈，但受限于总线带宽，同一时刻仅能传输一个分组，多个分组同时竞争总线时易产生冲突和阻塞，从而成为系统吞吐量的瓶颈。
- **经互联网络交换**：  
  为克服总线带宽的限制，现代路由器采用由多级交叉开关（如图中的纵横式交换机）构成的专用互联网络结构。这种结构能够在多个输入端口同时向不同输出端口发送分组时，实现无冲突的并发传输，即具备**非阻塞**特性。该方案显著提升了交换结构的并发能力和吞吐量，因此被广泛应用于高速核心路由器。然而，其硬件实现复杂，成本也相对较高。

### 输出端口处理
下图展示了输出端口处理流程的更详细内容：
<figure style="text-align: center;">
  <img src="/illustrations/计网笔记4/4.png" alt="输出端口处理流程" width="70%">
  <figcaption>输出端口处理流程</figcaption>
</figure>

输出端口的功能与输入端口相对，主要负责将已缓存在输出端口内存中的分组取出，并发送到输出链路上。这一过程包括：从输出队列中选择并取出待发分组、执行必要的数据链路层处理以及物理层传输功能，最终将分组可靠地传送到输出链路。