---
title: 计网学习笔记-3
date: 2025-10-22 16:37:41
categories: 计网
description: 《计算机网络——自顶向下方法》第三章学习笔记。
tags: [计算机网络, 运输层]
---
# 运输层
## 运输层概述
运输层协议为运行在不同主机上的应用进程之间提供了**逻辑通信**功能，使它们能够透明地交换报文，而无需关心底层通信的复杂细节。运输层协议在主机上实现：在发送端，运输层将从发送应用进程接收到的报文封装成运输层分组，称为**报文段**，随后，这些报文段被传递给网络层。网络层为其添加网络层首部得到数据报，并负责将其发送至目的地。在接收端，网络层从数据报中提取运输层报文段，并且上交给运输层。运输层则处理接收到的报文段，使得数据可以被接收的应用进程使用。

### 运输层和网络层
网络层提供了**主机间**的逻辑通信，而运输层则为运行在不同主机上的**进程**提供了逻辑通信。在整个数据传输过程中，网络中的路由器仅处理网络层的首部信息，对运输层报文段的内容既不检查也不修改，完全透明地转发。

计算机网络中可以支持多种运输层协议，每种协议为上层应用提供不同的服务模型。虽然运输层所能提供的服务在一定程度上受限于底层网络层的服务能力，但它并非完全被动依赖。例如，即使底层网络协议是不可靠的，或者说可能出现分组丢失、乱序甚至内容损坏等情况，运输层仍可通过自身机制（如确认、重传、校验等）向上层提供可靠的数据传输服务。同样，尽管运输层通常无法保证通信的机密性（这通常由应用层或安全协议如 TLS 处理），但它可以通过差错检查机制在一定程度上防止报文在传输过程中被未授权方窃取或篡改。因此，运输层在弥补网络层不足、提升通信质量方面发挥着关键作用。

### 因特网运输层
如前所述，运输层有两种协议：TCP 和 UDP。为了理解为什么它们会有区别，我们有必要先了解一些网络层的基础知识，尤其是关于 IP 地址更深入的一些内容。事实上，IP 协议是网络层的核心协议之一，它为主机之间提供了逻辑通信。IP 协议是尽力而为交付协议，这意味着它不确保报文段的交付，也不确保顺序和完整性。正因如此，IP 协议被视为一种不可靠的服务。每台主机至少有一个网络层地址，即 IP 地址。我们将在 4、5 章中更加详细地了解 IP 地址的相关内容。

TCP 和 UDP 最基本的责任是将两台主机间 IP 的交付服务扩展为运行在两台主机上的两个进程间的交付服务，这被称作运输层的**多路复用**与**多路分解**。TCP 和 UDP 还可以通过在其报文段首部中包括差错检查字段来提供完整性检查。进程到进程的数据交付和差错检查是两种最低限度的运输层服务，也是 UDP 所能提供的仅有的两种服务。另外，与 IP 一样，UDP 也是不可靠的服务。虽然其包含差错检查机制，但它不会重传，也不确认，更不保证顺序或完整性。因此，尽管 UDP 有差错检查能力，它仍然被归类为不可靠的传输协议。

另一方面，TCP 为应用程序提供了几种附加服务。首先，TCP 提供**可靠数据传输**服务。通过序号、确认、定时器和流量控制等机制，TCP 可以确保数据能够**无差错、不丢失、不重复且按序**地从发送进程交付到接收进程。其次，TCP 还实现了**拥塞控制**，用于防止某条 TCP 连接因发送过多数据而使网络过载；它通过动态调节发送速率，来适应当前网络的拥塞状况，从而提升整体网络的稳定性和效率。

## 多路复用和多路分解
在目的主机，运输层从网络层接收报文段，并负责将其中的数据交付给主机上相应的应用进程。我们知道，每个进程通常关联一个或多个套接字。因此，运输层实际上并不是直接将数据交给进程，而是交付给对应的套接字。因为套接字不唯一，所以每个套接字都有一个唯一的标识符，该标识符的具体格式取决于套接字所使用的运输层协议，TCP 套接字和 UDP 套接字的标识方式有所不同。

为了准确地定位目标套接字，运输层报文段包含几个关键字段，其中最重要的是**源端口号**和**目的端口号**（TCP 和 UDP 各自特有的其他首部字段将在后续介绍）。端口号是一个 16 位的无符号整数，取值范围为 0 到 65535。其中，0 到 1023 被称为**周知端口号**，被保留给常用的应用层协议使用，例如 HTTP 默认使用 80，HTTPS 使用 443，这些端口通常需要特权权限才能绑定。当开发新的应用程序时，必须为其分配一个**未被占用的端口号**。通常会使用 1024 到 65535 范围内的端口，以避免与系统服务冲突。

所以多路分解其实也很简单，就是报文段到达主机时运输层检查其目的端口号并定向到相应的套接字，然后数据就会通过套接字进入其所连接的进程。UDP 实际上大概也就是这么做的。然而，如我们所想，TCP 中的多路复用和多路分解实际上会更加复杂。

### 无连接的多路复用和多路分解
以 Python 代码为例，当执行 `clientSocket = socket(AF_INET, SOCK_DGRAM)` 创建一个 UDP 套接字时，运输层会为其自动分配一个**未被使用的临时端口号**，通常位于 1024 至 65535 的范围内。若需显式指定端口，则可调用 `clientSocket.bind(('', 19157))` 将该套接字绑定到指定端口（例如 19157）。

而在实现**周知协议的服务器端**时，必须将套接字绑定到对应的**周知端口号**，以便客户端能够按照约定访问服务。一般而言，客户端端口可由系统自动分配，而服务器端则必须显式绑定到固定端口，从而确保服务能够被正确寻址与访问。

实际上，一个 UDP 套接字由目的 IP 地址和目的端口号组成的二元组唯一标识，这里的 IP 地址是运输层处理数据报时得到的。无论报文段来自哪个源 IP 地址或源端口号，只要其目的 IP 地址和目的端口号相同，运输层就会将其交付给同一个套接字，进而传递给对应的目标进程。源 IP 地址和源端口号并不参与套接字的标识，它们的主要作用是为接收方提供**返回地址**，便于回复数据。

### 有连接的多路复用和多路分解
与 UDP 套接字不同，一个 TCP 套接字由一个四元组（源 IP 地址、源端口号、目的 IP 地址、目的端口号）来标识。因此，当 TCP 报文段从网络到达一台主机时，主机会使用全部四个值来定向到相应的套接字。两个源 IP 地址或源端口号不同的 TCP 报文段将被定位到两个不同的套接字，除非它携带了初始创建连接的请求。携带初始连接请求的报文段仅使用目的 IP 地址和目的端口号来定位套接字，这样可以确保多个客户能够同时连接到同一个服务器套接字，而不会发生冲突。

下图是一个比较复杂的通信例子，其中主机 C 与 主机 B 有两个 HTTP 会话，主机 A 和 主机 B 有一个 HTTP 会话，主机 A 和主机 C 的一个会话有相同的源端口号。但此时服务器 B 仍然可以正确地分解连接，因为它们有不同的源 IP 地址。

<figure style="text-align: center;">
  <img src="/illustrations/计网笔记3/1.png" alt="通信例子" width="80%">
  <figcaption>通信例子</figcaption>
</figure>

## UDP
UDP 看似不可靠，但其实际上也有许多优势，因此被保留至今。首先因为没有拥塞控制，所以对发送数据内容和发送时间的控制更加精细，适合一些实时应用；其次因为无需连接建立，所以没有额外时延，对服务器负担也小，可以提供更快更多的服务；最后因为其首部仅有 8 字节，所以开销也小。

还有一点需要再次强调，就是使用 UDP 的应用是可以实现可靠数据传输的。通过在应用层实现确认和重传机制，UDP 也能提供可靠的数据传输服务。例如，DNS 协议虽然基于 UDP，但它通过应用层的重传机制确保查询结果的可靠交付。因此，UDP 的不可靠性并不意味着应用层无法实现可靠通信，这仍然取决于具体的应用需求和设计。

### UDP 报文结构
UDP 报文结构如下所示，其首部仅有四个字段。除了我们之前讨论过的源端口号和目的端口号，还有用于指示 UDP 报文段总字节数的长度字段和用于进行差错检验的检验和字段。

<figure style="text-align: center;">
  <img src="/illustrations/计网笔记3/2.png" alt="UDP 报文格式" width="35%">
  <figcaption>UDP 报文格式</figcaption>
</figure>

### UDP 检验和
UDP 检验和提供了差错检测功能，用于检测其中的比特是否发生改变。发送方的 UDP 对报文段的所有 16 比特字的和进行反码加法，求和时遇到的所有溢出都被回卷，得到的结果取反码放在检验和字段。例如，假定发送方的 UDP 报文段包含下面三个 16 比特字：

$$
\begin{aligned}
1101\ 1010\ 1010\ 1010 \\
0110\ 0110\ 0110\ 0110 \\
0001\ 0001\ 0001\ 0001
\end{aligned}
$$

那么发送方会如下计算它们的和：
$$
\begin{array}{r}
  1101\ 1010\ 1010\ 1010 \\
+ \ 0110\ 0110\ 0110\ 0110 \\
\hline
1\ 0100\ 0001\ 0001\ 0000 \\
\text{(回卷进位)}\quad\quad\quad +\ 1 \\
\hline
  0100\ 0001\ 0001\ 0001 \\
+ \ 0001\ 0001\ 0001\ 0001 \\
\hline
  0101\ 0010\ 0010\ 0010 \\
\text{(取反得校验和)}\quad\quad\quad \\
\hline
  1010\ 1101\ 1101\ 1101 \\
\end{array}
$$

之所以在运输层提供差错检测，正是基于**端到端原则**。尽管许多链路层协议确实具备差错检测能力，但我们无法保证网络中**所有链路**都提供此类保护；更重要的是，即使数据在每一段链路上都正确传输，仍可能在中间节点（如路由器）或端系统的内存中因硬件故障、软件错误等原因发生**比特翻转**等损坏。

因此，端到端原则指出：若某项功能（如数据完整性）必须由通信的两端才能完整、可靠地实现，那么将其置于高层（如运输层）比依赖底层更有效；相比之下，在底层实现这类功能可能是冗余的，甚至毫无价值的。

UDP 虽然提供了差错检测（通过校验和），但其对错误**几乎不进行恢复**。一旦检测到损坏，UDP 通常只会静默丢弃该报文段，或在某些实现中将数据连同错误提示一并交给应用程序。它不重传、不确认，也不保证交付，因此仍被视为不可靠协议。

## 可靠数据传输原理
